# 1. 워크플로우의 이름입니다. GitHub Actions 탭에서 이 이름으로 표시됩니다.
name: Django-Docker-CI

# 2. 어떤 사건(Event)이 발생했을 때 이 로봇(Actions)을 깨울지 정합니다.
on:
  push:
    branches: [ "main" ]      # main 브랜치에 코드가 합쳐지면(Push/Merge) 실행
  pull_request:
    branches: [ "**" ]        # 모든 브랜치에서 PR을 생성하거나 업데이트하면 실행

# 3. 실제로 수행할 작업(Job)들을 정의합니다.
jobs:
  build:
    # 실행 환경: 최신 우분투 리눅스 가상 환경에서 돌아갑니다.
    runs-on: ubuntu-latest

    steps:
      # [Step 1] GitHub 서버에 있는 내 코드를 가상 컴퓨터로 복사해옵니다.
      - name: 1. 코드 체크아웃 (Checkout code)
        uses: actions/checkout@v4

      # [Step 2] Dockerfile에서 설정한 파이썬 버전(3.11) 환경을 가상 컴퓨터에 설치합니다.
      - name: 2. 파이썬 환경 설정 (Set up Python 3.11)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # [Step 3] 도커 허브에 이미지를 올리기 위해 로그인을 합니다.
      # 이 정보는 이전에 설정한 GitHub Secrets에서 안전하게 가져옵니다.
      - name: 3. 도커 허브 로그인 (Log in to Docker Hub)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      # [Step 4] 이 워크플로우의 핵심! 이미지에 붙일 '버전 숫자(태그)'를 결정합니다.
      - name: 4. 도커 이미지 태그 생성 (Set Docker Image Tag)
        id: set_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub CLI 사용을 위한 자동 토큰
        run: |
          # A. 만약 현재 상황이 'Pull Request(PR)' 중이라면?
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # 태그 형식 예: 0.15(PR번호).5(실행번호) -> "테스트 버전" 의미
            DOCKER_IMAGE_TAG="0.${{ github.event.pull_request.number }}.${{ github.run_number }}"
          
          # B. 만약 현재 상황이 'Main 브랜치'에 코드가 들어온 상황이라면?
          elif [ "${{ github.ref_name }}" == "main" ]; then
            # 방금 합쳐진(Merged) PR 번호를 GitHub CLI를 통해 찾아냅니다.
            PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --state closed --json number,mergeCommit --jq ".[] | select(.mergeCommit.oid == \"${{ github.sha }}\") | .number" | head -n 1)
            
            # 만약 PR 없이 직접 Push했거나 번호를 못 찾았다면 '실행번호'를 대신 사용합니다 (안전장치)
            if [ -z "$PR_NUMBER" ]; then
              DOCKER_IMAGE_TAG="1.1.${{ github.run_number }}"
            else
              # 정식 버전 예: 1.1.15(PR번호) -> "배포 가능 버전" 의미
              DOCKER_IMAGE_TAG="1.1.$PR_NUMBER"
            fi
          
          # C. 그 외 브랜치 작업 시
          else
            DOCKER_IMAGE_TAG="test-${{ github.run_number }}"
          fi
          
          # 생성된 태그를 다음 단계에서 사용할 수 있도록 저장(Output)합니다.
          echo "DOCKER_IMAGE_TAG=$DOCKER_IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Final Determined Tag: $DOCKER_IMAGE_TAG"

      # [Step 5] 작성한 Dockerfile을 바탕으로 이미지를 빌드하고 도커 허브로 쏩니다.
      - name: 5. 이미지 빌드 및 푸시 (Build and push Docker image)
        uses: docker/build-push-action@v5
        with:
          context: .               # Dockerfile이 있는 위치 (현재 폴더)
          push: true               # 빌드 완료 후 도커 허브로 전송 여부
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/backend:${{ steps.set_tag.outputs.DOCKER_IMAGE_TAG }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/backend:latest 
      
      - name: Trigger Deployment
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_PAT }} # Personal Access Token이 필요합니다.
          repository: 2025-Techeer-Winter-Bootcamp-Team-E/Backend_deploy # 배포 레포 이름
          event-type: trigger-deploy 