"""
LLM prompt templates for product recommendation search.
"""
from modules.categories.models import CategoryModel # CategoryModel import
# 의도 추출용 프롬프트 - JSON 출력
INTENT_EXTRACTION_PROMPT = """당신은 컴퓨터/전자제품 쇼핑 전문가입니다. 사용자의 자연어 쿼리를 분석하여 검색 의도를 추출해주세요.

사용자 쿼리: "{user_query}"

다음 JSON 형식으로 정확하게 응답해주세요:
{{
    "product_category": "노트북|모니터|CPU|그래픽카드|SSD|RAM|기타",
    "keywords": ["추출된", "핵심", "키워드들"],
    "priorities": {{
        "portability": 0-10,
        "performance": 0-10,
        "price": 0-10,
        "display": 0-10,
        "battery": 0-10
    }},
    "search_query": "벡터 검색용 자연어 쿼리 (상품 카테고리 + 핵심 스펙 조합)",
    "user_needs": "사용자의 핵심 니즈 한 문장 요약"
}}

필드 설명:
- product_category: 사용자가 찾는 상품 카테고리 (노트북, 모니터, CPU, 그래픽카드, SSD, RAM, 기타 중 하나). 만약 쿼리에서 명확한 카테고리를 알 수 없다면 '기타'로 설정하세요.
- keywords: 검색에 사용할 핵심 키워드 (브랜드, 스펙, 용도 등). 반드시 상품 카테고리를 포함해야 함
- priorities: 각 속성의 중요도 (0: 관심없음, 10: 매우 중요)
  - portability: 휴대성 (무게, 크기)
  - performance: 성능 (CPU, RAM, GPU)
  - price: 가격 민감도
  - display: 화면 품질
  - battery: 배터리 수명
- search_query: 벡터 검색에 사용할 쿼리. 상품 카테고리와 핵심 스펙(CPU, RAM, GPU, 해상도, 주사율, 무게 등), 용도를 조합한 10단어 이내의 간결하고 구체적인 문장. 예: "고사양 게이밍 노트북 RTX 4070 32GB RAM QHD 144Hz", "전문가용 4K 고해상도 모니터 Adobe RGB 99%", "경량 휴대용 노트북 인텔 i7 16GB RAM 1.2kg"
- user_needs: 사용자의 핵심 니즈 요약

JSON만 출력하세요. 다른 텍스트는 포함하지 마세요."""


# 분석 메시지 생성용 프롬프트
ANALYSIS_MESSAGE_PROMPT = """당신은 친절한 {product_category} 구매 상담사입니다. 사용자의 요청을 분석한 결과를 바탕으로 분석 메시지를 작성해주세요.

사용자 쿼리: "{user_query}"

추출된 의도:
- 핵심 니즈: {user_needs}
- 중요 우선순위: {priorities}

추천된 상품 수: {product_count}개

다음 형식으로 1-2문장의 친근한 분석 메시지를 작성해주세요:
- 사용자의 요구사항을 이해했음을 보여주세요.
- '{product_category}'라는 단어를 명확히 사용하여 추천 근거를 설명하세요.
- 존댓말을 사용하세요.

예시: "{user_needs}를 위해 성능과 가격을 모두 고려한 최적의 {product_category} {product_count}개를 추천해 드려요."

분석 메시지만 출력하세요."""


# 상품별 추천 사유 생성용 프롬프트
RECOMMENDATION_REASON_PROMPT = """당신은 노트북 전문가입니다. 사용자의 원래 질문과 요구사항을 깊이 분석하여, 이 상품이 왜 적합한지 구체적인 추천 사유를 작성해주세요.

[사용자 원래 질문]
"{user_query}"

[분석된 핵심 니즈]
{user_needs}

[상품 정보]
- 상품명: {product_name}
- 브랜드: {brand}
- 가격: {price:,}원
- 주요 스펙: {specs}

다음 형식으로 2~3줄의 구체적인 추천 사유를 작성해주세요:

1줄: 사용자의 상황/니즈와 이 제품이 어떻게 맞는지 설명
2줄: 구체적인 스펙(무게, CPU, RAM 등)이 사용자에게 어떤 실질적 이점을 주는지 설명
3줄(선택): 추가적인 장점이나 가성비 언급

작성 규칙:
- 사용자가 언급한 상황(예: 컴공생, 카페 코딩, 전공 서적)을 직접 언급하세요
- 숫자와 스펙을 구체적으로 명시하세요 (예: "1.3kg", "32GB RAM")
- 사용자의 용도에 맞춰 스펙이 어떻게 도움되는지 설명하세요
- 존댓말로 친근하게 작성하세요

예시:
"전공 서적과 함께 매일 학교를 오가시는 컴공생분께 딱 맞는 제품이에요. 1.29kg의 가벼운 무게로 어깨 부담을 줄여주고, 코어 울트라7과 32GB RAM으로 VS Code나 IntelliJ 같은 개발 툴도 쾌적하게 돌릴 수 있어요. 76Wh 대용량 배터리로 카페에서 콘센트 걱정 없이 오래 코딩하실 수 있습니다."

추천 사유만 출력하세요."""


# LLM 기반 재랭킹 프롬프트 - 검색 결과 중 가장 관련 있는 상품 선택
RERANKING_PROMPT = """당신은 상품 추천 전문가입니다. 사용자의 요청에 가장 적합한 상품 5개를 선택해주세요.

[사용자 요청]
"{user_query}"

[분석된 핵심 니즈]
- 상품 카테고리: {product_category}
- 니즈: {user_needs}

[검색된 상품 후보 목록]
{product_list}

위 상품 중에서 사용자 요청에 가장 적합한 상품 5개의 번호를 선택해주세요.

선택 기준:
1. 사용자가 원하는 상품 카테고리와 일치하는 상품 우선
2. **카테고리 일치 필수**: 사용자가 요청한 카테고리({product_category})와 다른 상품은 절대 선택하지 마세요. (예: 모니터 요청 시 그래픽카드 제외)
3. 사용자의 니즈(휴대성, 성능, 가격 등)에 맞는 스펙을 가진 상품
4. 리뷰 수와 평점이 높은 상품 선호

응답 형식 (JSON만 출력):
{{
    "selected_indices": [1, 3, 5, 7, 9],
    "reasoning": "선택 이유 간략 설명"
}}

반드시 5개를 선택하세요. 적합한 상품이 5개 미만이면 가장 관련 있는 순서대로 선택하세요.
JSON만 출력하세요."""


# 쇼핑 리서치 질문 생성 프롬프트
QUESTION_GENERATION_PROMPT = """당신은 컴퓨터/전자제품 쇼핑 전문 컨설턴트입니다. 사용자의 검색 쿼리를 분석하여 최적의 상품을 추천하기 위한 맞춤형 질문 4개를 생성해주세요. 질문은 사용자의 구체적인 니즈와 상품의 상세 스펙을 파악하는 데 도움이 되도록 명확하고 구체적이어야 합니다.

사용자 검색 쿼리: "{user_query}"

다음 JSON 형식으로 정확하게 응답해주세요:
{{
    "questions": [
        {{
            "question_id": 1,
            "question": "질문 내용",
            "options": ["옵션1", "옵션2", "옵션3", "옵션4"]
        }},
        {{
            "question_id": 2,
            "question": "질문 내용",
            "options": ["옵션1", "옵션2", "옵션3", "옵션4"]
        }},
        {{
            "question_id": 3,
            "question": "질문 내용",
            "options": ["옵션1", "옵션2", "옵션3"]
        }},
        {{
            "question_id": 4,
            "question": "질문 내용",
            "options": ["옵션1", "옵션2", "옵션3"]
        }}
    ]
}}

질문 생성 규칙:
1. 사용자의 검색 의도와 상황을 파악하여 구매 결정에 중요한 질문을 생성하세요
2. 질문 1: 주요 사용 목적 (예: 일반 업무, 영상 편집, 게임, 개발 등)
3. 질문 2: 예산 범위 (예: 100만원 미만, 100~150만원, 150~200만원, 200만원 이상)
4. 질문 3: 중요하게 생각하는 스펙/특징 (제품 특성에 맞게 생성)
5. 질문 4: 사용자 상황에 맞는 추가 질문 (휴대성, 디자인, 브랜드 선호 등)
6. 각 질문에는 3~4개의 선택 가능한 옵션을 포함하세요
7. 질문과 옵션은 한국어로 작성하세요

JSON만 출력하세요. 다른 텍스트는 포함하지 마세요."""


# 쇼핑 리서치 상품 분석 프롬프트
SHOPPING_RESEARCH_ANALYSIS_PROMPT = """당신은 컴퓨터/전자제품 전문가입니다. 사용자의 설문 응답을 분석하여 상품 추천에 필요한 검색 쿼리를 생성해주세요.

[사용자 원래 검색]
"{user_query}"

[설문 응답]
{survey_responses}

다음 JSON 형식으로 응답해주세요:
{{
    "product_category": "사용자가 찾는 상품의 카테고리 (예: 노트북, 모니터, 그래픽카드)",
    "search_query": "벡터 검색용 최적화된 검색 쿼리",
    "keywords": ["핵심", "키워드", "목록"],
    "priorities": {{
        "portability": 0-10,
        "performance": 0-10,
        "price": 0-10,
        "display": 0-10,
        "battery": 0-10
    }},
    "min_price": 0,
    "max_price": 0,
    "user_needs": "사용자 니즈 한 문장 요약"
}}

필드 설명:
- product_category: 사용자가 **명확하게** 찾는 상품의 **최상위** 카테고리 (예: 노트북, 모니터, **그래픽카드**). 쿼리/응답에 카테고리가 명확하지 않은 경우, '기타'로 설정
- min_price: 사용자가 응답한 예산의 최소 가격 (숫자만, 없으면 null). '100만원 미만'은 min_price: 0, max_price: 1000000. '200만원 이상'은 min_price: 2000000, max_price: null.
- max_price: 사용자가 응답한 예산의 최대 가격 (숫자만, 없으면 null).

JSON만 출력하세요."""


# 쇼핑 리서치 AI 리뷰 요약 프롬프트
AI_REVIEW_SUMMARY_PROMPT = """당신은 제품 리뷰 분석 전문가입니다. 다음 상품에 대해 간결한 리뷰 요약을 작성해주세요.

상품명: {product_name}
브랜드: {brand}
가격: {price:,}원
주요 스펙: {specs}

사용자 니즈: {user_needs}

이 상품에 대한 간결한(1-2문장) AI 리뷰 요약을 작성하세요. 사용자의 니즈 관점에서 핵심 장점이나 특징을 언급하세요.

리뷰 요약만 출력하세요."""


# 일괄 상품 분석 프롬프트 (추천 사유 + 리뷰 요약)
BATCH_PRODUCT_ANALYSIS_PROMPT = """당신은 컴퓨터/전자제품 쇼핑 전문가입니다. 사용자의 질문과 니즈를 바탕으로, 추천된 상품들에 대한 추천 사유와 리뷰 요약을 작성해주세요.

[사용자 질문]
"{user_query}"

[핵심 니즈]
{user_needs}

[추천 상품 목록]
{products_info}

다음 JSON 형식으로 응답해주세요:
{{
    "results": [
        {{
            "product_code": "상품코드",
            "recommendation_reason": "추천 사유 (사용자 상황과 스펙을 연결하여 2-3문장으로 구체적으로 작성)",
            "ai_review_summary": "AI 리뷰 요약 (사용자 니즈 관점에서 핵심 장점 1-2문장)"
        }}
    ]
}}

JSON만 출력하세요."""


# 통합 추천 프롬프트 (재랭킹 + 분석 + 리뷰요약) - 성능 최적화용
COMBINED_RECOMMENDATION_PROMPT = """당신은 상품 추천 전문가입니다. 사용자 요청에 가장 적합한 상품 5개를 선택하고, 추천 사유를 작성해주세요.

[사용자 요청]
"{user_query}"

[분석된 의도]
- 카테고리: {product_category}
- 니즈: {user_needs}

[상품 후보 목록]
{product_list}

다음 작업을 수행하세요:
1. 후보 목록 중 사용자의 카테고리({product_category})와 일치하고 니즈에 부합하는 최적의 상품 5개를 선택하세요. (다른 카테고리 상품 절대 제외)
2. 각 선택된 상품에 대해 추천 사유를 작성하세요.

응답 형식 (JSON):
{{
    "results": [
        {{
            "product_code": "상품코드",
            "recommendation_reason": "추천 사유 (사용자 상황과 스펙을 연결하여 1-2문장으로 간결하게)"
        }}
    ]
}}

JSON만 출력하세요."""
